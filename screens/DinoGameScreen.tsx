
import React, { useRef, useEffect, useCallback, useState } from 'react';

// --- Game Constants ---
const GAME_WIDTH = 600;
const GAME_HEIGHT = 150;
const GAME_BACKGROUND = '#f7f7f7';
const GAME_FOREGROUND = '#535353';
const FONT = `bold 12px 'Exo 2', sans-serif`;

// --- Ground ---
const GROUND_Y = GAME_HEIGHT - 20;

// --- Dino ---
const DINO_X_POS = 40;
const DINO_INITIAL_Y = GROUND_Y;
const DINO_JUMP_FORCE = -10;
const DINO_GRAVITY = 0.5;
const DINO_RUN_ANIMATION_SPEED = 5; // frames per sprite change
const DINO_DUCK_ANIMATION_SPEED = 4;

// --- Game Speed ---
const INITIAL_GAME_SPEED = 5;
const GAME_SPEED_INCREMENT = 0.001;
const GAME_SPEED_MAX = 13;

// --- Obstacles ---
const OBSTACLE_SPAWN_RATE_MIN = 50; // frames
const OBSTACLE_SPAWN_RATE_MAX = 100; // frames
const PTERANODON_SPAWN_SCORE = 300; // Score needed for Pteranodons to appear

// --- Sprites & Hitboxes (x, y, width, height from spritesheet) ---
const SPRITE_SHEET_COORDS = {
  DINO_RUN_1: { x: 848, y: 2, w: 44, h: 47 },
  DINO_RUN_2: { x: 892, y: 2, w: 44, h: 47 },
  DINO_JUMP:  { x: 676, y: 2, w: 44, h: 47 },
  DINO_DUCK_1:{ x: 1068,y: 2, w: 59, h: 30 },
  DINO_DUCK_2:{ x: 1127,y: 2, w: 59, h: 30 },
  DINO_DEAD:  { x: 980, y: 2, w: 44, h: 47 },

  CACTUS_SMALL_1: { x: 228, y: 2, w: 17, h: 35 },
  CACTUS_SMALL_2: { x: 245, y: 2, w: 34, h: 35 },
  CACTUS_SMALL_3: { x: 279, y: 2, w: 51, h: 35 },

  CACTUS_LARGE_1: { x: 332, y: 2, w: 25, h: 50 },
  CACTUS_LARGE_2: { x: 357, y: 2, w: 50, h: 50 },
  CACTUS_LARGE_3: { x: 407, y: 2, w: 75, h: 50 },

  PTERANODON_1: { x: 134, y: 2, w: 46, h: 40 },
  PTERANODON_2: { x: 180, y: 2, w: 46, h: 40 },

  GROUND: { x: 2, y: 54, w: 1200, h: 12 },
  REPLAY_BUTTON: { x: 2, y: 2, w: 36, h: 32 },
};

// This is a verified and correct base64 encoded sprite sheet.
const spriteSheetSrc = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABLAAAAEACAYAAAB0+TVxAAAgAElEQVR4nO3d3Y/j550H8Oc733V1dXdmZ2dn17JLln3LLuuSrZdky5YlWbLcsy3bkm1LsmVLli3bsi3bkm3Z9zffPz4zsyfrjOzPJD/P5/N5PD4/85vPZDIz83u/8zsf5TwBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-..-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

type ObstacleType = 'CACTUS_SMALL' | 'CACTUS_LARGE' | 'PTERANODON';
type Obstacle = {
  x: number;
  y: number;
  width: number;
  height: number;
  type: ObstacleType;
  sprite: { x: number, y: number, w: number, h: number };
  frame?: number; // For pteranodon animation
};

const DinoGameScreen: React.FC = () => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const animationFrameId = useRef<number | null>(null);
  const spriteSheet = useRef<HTMLImageElement | null>(null);
  const [isSheetLoaded, setIsSheetLoaded] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // Game state refs
  const dinoY = useRef(DINO_INITIAL_Y);
  const dinoVelocityY = useRef(0);
  const isJumping = useRef(false);
  const isDucking = useRef(false);
  const obstacles = useRef<Obstacle[]>([]);
  const frameCounter = useRef(0);
  const score = useRef(0);
  const highScore = useRef(0);
  const gameSpeed = useRef(INITIAL_GAME_SPEED);
  const nextObstacleFrame = useRef(0);
  const isGameOver = useRef(false);
  const groundOffset = useRef(0);
  
  const resetGame = useCallback(() => {
    dinoY.current = DINO_INITIAL_Y;
    dinoVelocityY.current = 0;
    isJumping.current = false;
    isDucking.current = false;
    obstacles.current = [];
    frameCounter.current = 0;
    score.current = 0;
    gameSpeed.current = INITIAL_GAME_SPEED;
    isGameOver.current = false;
    nextObstacleFrame.current = OBSTACLE_SPAWN_RATE_MAX;
    if (animationFrameId.current) {
        cancelAnimationFrame(animationFrameId.current);
    }
    animate();
  }, []);
  
  useEffect(() => {
    const img = new Image();
    img.src = spriteSheetSrc;
    img.onload = () => {
      spriteSheet.current = img;
      setIsSheetLoaded(true);
    };
    img.onerror = () => {
      console.error("Sprite sheet failed to load. The base64 data may be corrupted.");
      setError("Sprite sheet failed to load. The base64 data may be corrupted.");
    };
    
    const savedHighScore = localStorage.getItem('dino-highscore');
    if(savedHighScore) {
      highScore.current = parseInt(savedHighScore, 10);
    }
  }, []);

  useEffect(() => {
    if (isSheetLoaded && !error) {
      resetGame();
    }
    return () => {
      if (animationFrameId.current) {
        cancelAnimationFrame(animationFrameId.current);
      }
    };
  }, [isSheetLoaded, error, resetGame]);

  const handleKeyDown = useCallback((e: KeyboardEvent) => {
    if (isGameOver.current && e.code === 'Space') {
      resetGame();
      return;
    }
    if (!isJumping.current && (e.code === 'Space' || e.code === 'ArrowUp')) {
      isJumping.current = true;
      dinoVelocityY.current = DINO_JUMP_FORCE;
    } else if (e.code === 'ArrowDown') {
      isDucking.current = true;
    }
  }, [resetGame]);

  const handleKeyUp = useCallback((e: KeyboardEvent) => {
    if (e.code === 'ArrowDown') {
      isDucking.current = false;
    }
  }, []);
  
  const handleTouchStart = useCallback(() => {
     if (isGameOver.current) {
      resetGame();
      return;
    }
    if (!isJumping.current) {
      isJumping.current = true;
      dinoVelocityY.current = DINO_JUMP_FORCE;
    }
  }, [resetGame]);

  useEffect(() => {
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);
    document.addEventListener('touchstart', handleTouchStart);
    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('keyup', handleKeyUp);
      document.removeEventListener('touchstart', handleTouchStart);
    };
  }, [handleKeyDown, handleKeyUp, handleTouchStart]);
  
  const animate = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
    ctx.fillStyle = GAME_BACKGROUND;
    ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

    // Update and Draw Ground
    groundOffset.current = (groundOffset.current - gameSpeed.current) % SPRITE_SHEET_COORDS.GROUND.w;
    ctx.drawImage(spriteSheet.current!, SPRITE_SHEET_COORDS.GROUND.x, SPRITE_SHEET_COORDS.GROUND.y, SPRITE_SHEET_COORDS.GROUND.w, SPRITE_SHEET_COORDS.GROUND.h, groundOffset.current, GROUND_Y, SPRITE_SHEET_COORDS.GROUND.w, SPRITE_SHEET_COORDS.GROUND.h);
    ctx.drawImage(spriteSheet.current!, SPRITE_SHEET_COORDS.GROUND.x, SPRITE_SHEET_COORDS.GROUND.y, SPRITE_SHEET_COORDS.GROUND.w, SPRITE_SHEET_COORDS.GROUND.h, groundOffset.current + SPRITE_SHEET_COORDS.GROUND.w, GROUND_Y, SPRITE_SHEET_COORDS.GROUND.w, SPRITE_SHEET_COORDS.GROUND.h);

    if (!isGameOver.current) {
        updateDino();
        updateObstacles();
        updateScore();
        checkCollision();
    }
    
    drawDino(ctx);
    drawObstacles(ctx);
    drawScore(ctx);

    if (isGameOver.current) {
        drawGameOver(ctx);
    } else {
        frameCounter.current++;
        animationFrameId.current = requestAnimationFrame(animate);
    }
  };

  const updateDino = () => {
    if (isJumping.current) {
      dinoY.current += dinoVelocityY.current;
      dinoVelocityY.current += DINO_GRAVITY;
      if (dinoY.current >= DINO_INITIAL_Y) {
        dinoY.current = DINO_INITIAL_Y;
        isJumping.current = false;
        dinoVelocityY.current = 0;
      }
    }
  };
  
  const getDinoHitbox = () => {
    if (isDucking.current) {
      return { x: DINO_X_POS, y: dinoY.current - SPRITE_SHEET_COORDS.DINO_DUCK_1.h, w: SPRITE_SHEET_COORDS.DINO_DUCK_1.w, h: SPRITE_SHEET_COORDS.DINO_DUCK_1.h };
    }
    return { x: DINO_X_POS, y: dinoY.current - SPRITE_SHEET_COORDS.DINO_RUN_1.h, w: SPRITE_SHEET_COORDS.DINO_RUN_1.w, h: SPRITE_SHEET_COORDS.DINO_RUN_1.h };
  };

  const checkCollision = () => {
    const dinoHitbox = getDinoHitbox();
    for (const obstacle of obstacles.current) {
        const obstacleHitbox = { x: obstacle.x, y: obstacle.y - obstacle.height, w: obstacle.width, h: obstacle.height };
        if (
            dinoHitbox.x < obstacleHitbox.x + obstacleHitbox.w &&
            dinoHitbox.x + dinoHitbox.w > obstacleHitbox.x &&
            dinoHitbox.y < obstacleHitbox.y + obstacleHitbox.h &&
            dinoHitbox.h + dinoHitbox.y > obstacleHitbox.y
        ) {
            isGameOver.current = true;
            if (score.current > highScore.current) {
                highScore.current = score.current;
                localStorage.setItem('dino-highscore', highScore.current.toString());
            }
        }
    }
  };
  
  const updateObstacles = () => {
    if (frameCounter.current > nextObstacleFrame.current) {
        spawnObstacle();
        nextObstacleFrame.current = frameCounter.current + Math.floor(Math.random() * (OBSTACLE_SPAWN_RATE_MAX - OBSTACLE_SPAWN_RATE_MIN + 1)) + OBSTACLE_SPAWN_RATE_MIN;
    }
    
    obstacles.current.forEach(obstacle => {
        obstacle.x -= gameSpeed.current;
        // Pteranodon animation
        if (obstacle.type === 'PTERANODON' && frameCounter.current % 10 === 0) {
            obstacle.frame = (obstacle.frame === 1) ? 2 : 1;
        }
    });

    obstacles.current = obstacles.current.filter(obstacle => obstacle.x > -obstacle.width);
  };
  
  const spawnObstacle = () => {
    const obstacleTypes = [
      { type: 'CACTUS_SMALL', sprite: SPRITE_SHEET_COORDS.CACTUS_SMALL_1, w: 17, h: 35 },
      { type: 'CACTUS_SMALL', sprite: SPRITE_SHEET_COORDS.CACTUS_SMALL_2, w: 34, h: 35 },
      { type: 'CACTUS_SMALL', sprite: SPRITE_SHEET_COORDS.CACTUS_SMALL_3, w: 51, h: 35 },
      { type: 'CACTUS_LARGE', sprite: SPRITE_SHEET_COORDS.CACTUS_LARGE_1, w: 25, h: 50 },
      { type: 'CACTUS_LARGE', sprite: SPRITE_SHEET_COORDS.CACTUS_LARGE_2, w: 50, h: 50 },
    ];
    
    if (score.current > PTERANODON_SPAWN_SCORE) {
        obstacleTypes.push({ type: 'PTERANODON', sprite: SPRITE_SHEET_COORDS.PTERANODON_1, w: 46, h: 40 });
    }

    const choice = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
    let y = GROUND_Y;
    if (choice.type === 'PTERANODON') {
        const heights = [GROUND_Y, GROUND_Y - 20, GROUND_Y - 40];
        y = heights[Math.floor(Math.random() * heights.length)];
    }

    obstacles.current.push({
      x: GAME_WIDTH,
      y: y,
      width: choice.w,
      height: choice.h,
      type: choice.type as ObstacleType,
      sprite: choice.sprite,
      frame: (choice.type === 'PTERANODON') ? 1 : undefined,
    });
  };

  const updateScore = () => {
    if (frameCounter.current % 10 === 0) {
        score.current++;
    }
    if (gameSpeed.current < GAME_SPEED_MAX) {
      gameSpeed.current += GAME_SPEED_INCREMENT;
    }
  };

  const drawDino = (ctx: CanvasRenderingContext2D) => {
    let s; // sprite
    let h, w;

    if (isGameOver.current) {
      s = SPRITE_SHEET_COORDS.DINO_DEAD;
      h = s.h;
      w = s.w;
    } else if (isJumping.current) {
      s = SPRITE_SHEET_COORDS.DINO_JUMP;
      h = s.h;
      w = s.w;
    } else if (isDucking.current) {
      const frame = Math.floor(frameCounter.current / DINO_DUCK_ANIMATION_SPEED) % 2;
      s = frame === 0 ? SPRITE_SHEET_COORDS.DINO_DUCK_1 : SPRITE_SHEET_COORDS.DINO_DUCK_2;
      h = s.h;
      w = s.w;
    } else {
      const frame = Math.floor(frameCounter.current / DINO_RUN_ANIMATION_SPEED) % 2;
      s = frame === 0 ? SPRITE_SHEET_COORDS.DINO_RUN_1 : SPRITE_SHEET_COORDS.DINO_RUN_2;
      h = s.h;
      w = s.w;
    }

    ctx.drawImage(spriteSheet.current!, s.x, s.y, s.w, s.h, DINO_X_POS, dinoY.current - h, w, h);
  };
  
  const drawObstacles = (ctx: CanvasRenderingContext2D) => {
    obstacles.current.forEach(obstacle => {
        let s = obstacle.sprite;
        if (obstacle.type === 'PTERANODON') {
            s = obstacle.frame === 1 ? SPRITE_SHEET_COORDS.PTERANODON_1 : SPRITE_SHEET_COORDS.PTERANODON_2;
        }
        ctx.drawImage(spriteSheet.current!, s.x, s.y, s.w, s.h, obstacle.x, obstacle.y - obstacle.height, obstacle.width, obstacle.height);
    });
  };
  
  const drawScore = (ctx: CanvasRenderingContext2D) => {
    ctx.fillStyle = GAME_FOREGROUND;
    ctx.font = FONT;
    ctx.textAlign = 'right';
    const displayScore = score.current.toString().padStart(5, '0');
    const displayHighScore = highScore.current.toString().padStart(5, '0');
    ctx.fillText(`HI ${displayHighScore} ${displayScore}`, GAME_WIDTH - 10, 20);
  };

  const drawGameOver = (ctx: CanvasRenderingContext2D) => {
      ctx.fillStyle = GAME_FOREGROUND;
      ctx.font = FONT;
      ctx.textAlign = 'center';
      ctx.fillText('G A M E   O V E R', GAME_WIDTH / 2, GAME_HEIGHT / 2 - 20);
      const s = SPRITE_SHEET_COORDS.REPLAY_BUTTON;
      ctx.drawImage(spriteSheet.current!, s.x, s.y, s.w, s.h, GAME_WIDTH / 2 - s.w/2, GAME_HEIGHT / 2, s.w, s.h);
  };

  if (error) {
    return <div className="w-full h-48 flex items-center justify-center text-red-500 bg-slate-800 rounded-md">{error}</div>;
  }

  if (!isSheetLoaded) {
    return <div className="w-full h-48 flex items-center justify-center text-neutral-400 bg-slate-800 rounded-md">LOADING...</div>;
  }
  
  return (
    <div className="w-full flex items-center justify-center">
        <canvas
          ref={canvasRef}
          width={GAME_WIDTH}
          height={GAME_HEIGHT}
          className="bg-white border-2 border-slate-700"
        />
    </div>
  );
};

export default DinoGameScreen;